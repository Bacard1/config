#!/bin/bash

show_menu() {
    echo "==========================="
    echo "  Системно меню"
    echo "==========================="
    #----------------------------------------------------------#
    # install openssh
    #----------------------------------------------------------#
    echo "1. Инсталиране на SSH"
    #----------------------------------------------------------#
    # set password and ssh-key
    #----------------------------------------------------------#
    echo "2. Задаване на парола и SSH ключ/нов потребител"
    #----------------------------------------------------------#
    # setup termux boot and services
    #----------------------------------------------------------#
    echo "3. Настройка на Termux:Boot и услуги"
    #----------------------------------------------------------#
    # show ssh keys
    #----------------------------------------------------------#
    echo "4. Покажи SSH ключове"
    #----------------------------------------------------------#
    # add key to authorized_keys
    #----------------------------------------------------------#
    echo "5. Добавяне на ключ в authorized_keys"
    #----------------------------------------------------------#
    # uninstall ssh
    #----------------------------------------------------------#
    echo "333. Деинсталиране на SSH"
    echo "0. Изход"
    echo
}

#----------------------------------------------------------#
# uninstall ssh
#----------------------------------------------------------#
uninstall_ssh() {
    echo "=== ДЕИНСТАЛИРАНЕ НА SSH И СВЪРЗАНИ УСЛУГИ ==="
    echo ""
    
    # Предупреждение
    echo "ВНИМАНИЕ: Тази операция ще:"
    echo "- Деактивира SSH услугата"
    echo "- Спре SSH услугата"
    echo "- Деинсталира OpenSSH пакета"
    echo "- Изтрие boot скриптовете"
    echo ""
    
    read -p "Сигурни ли сте, че искате да продължите? (да/не): " confirm
    
    case $confirm in
        [Дд]а|[Yy]es)
            echo "Започвам деинсталацията..."
            ;;
        *)
            echo "Деинсталацията е отменена."
            return
            ;;
    esac
    
    echo ""
    echo "=== СПИРАНЕ НА SSH УСЛУГАТА ==="
    sv down sshd 2>/dev/null
    echo "SSH услугата е спряна"
    
    echo ""
    echo "=== ДЕАКТИВИРАНЕ НА SSH УСЛУГАТА ==="
    sv-disable sshd 2>/dev/null
    echo "SSH услугата е деактивирана"
    
    echo ""
    echo "=== ПРЕМАХВАНЕ НА BOOT СКРИПТОВЕТЕ ==="
    if [ -f ~/.termux/boot/start-sshd ]; then
        rm ~/.termux/boot/start-sshd
        echo "Премахнат е boot скриптът ~/.termux/boot/start-sshd"
    else
        echo "Няма намерен boot скрипт за SSH"
    fi
    
    echo ""
    echo "=== ДЕИНСТАЛИРАНЕ НА OPENSSH ==="
    pkg uninstall openssh -y
    echo "OpenSSH е деинсталиран"
    
    echo ""
    echo "=== ДЕИНСТАЛИРАНЕ НА TERMUX-SERVICES (по избор) ==="
    read -p "Искате ли да деинсталирате и termux-services? (да/не): " uninstall_services
    
    case $uninstall_services in
        [Дд]а|[Yy]es)
            pkg uninstall termux-services -y
            echo "Termux-services е деинсталиран"
            ;;
        *)
            echo "Termux-services е запазен"
            ;;
    esac
    
    echo ""
    echo "=== ИЗТРИВАНЕ НА SSH КЛЮЧОВЕ (по избор) ==="
    read -p "Искате ли да изтриете SSH ключовете в ~/.ssh/? (да/не): " delete_keys
    
    case $delete_keys in
        [Дд]а|[Yy]es)
            if [ -d ~/.ssh ]; then
                rm -rf ~/.ssh
                echo "Директорията ~/.ssh е изтрита"
            else
                echo "Директорията ~/.ssh не съществува"
            fi
            ;;
        *)
            echo "SSH ключовете са запазени"
            ;;
    esac
    
    echo ""
    echo "=== ДЕИНСТАЛАЦИЯТА ЗАВЪРШИ ==="
    echo "Всички SSH компоненти са премахнати."
    echo "Ако желаете да ги инсталирате отново, използвайте опция 1 от менюто."
}

# ... останалите функции остават същите ...

while true; do
    show_menu
    read -p "Изберете опция [0-5, 333]: " choice
    case $choice in
        #----------------------------------------------------------#
        # install openssh
        #----------------------------------------------------------#    
        1)
            install_ssh
            ;;
        #----------------------------------------------------------#
        # set password and ssh-key
        #----------------------------------------------------------#    
        2)
            set_password_and_sshkey
            ;;
        #----------------------------------------------------------#
        # setup termux boot and services
        #----------------------------------------------------------#
        3)
            setup_boot_services
            ;;
        #----------------------------------------------------------#
        # show ssh keys
        #----------------------------------------------------------#
        4)
            show_ssh_keys
            ;;
        #----------------------------------------------------------#
        # add key to authorized_keys
        #----------------------------------------------------------#
        5)
            add_to_authorized_keys
            ;;
        #----------------------------------------------------------#
        # uninstall ssh
        #----------------------------------------------------------#
        333)
            uninstall_ssh
            ;;
        0)
            echo "Довиждане!"
            exit 0
            ;;
        *)
            echo "Невалиден избор! Моля опитайте отново."
            ;;
    esac
    echo
    read -p "Натиснете Enter за да продължите..."
    echo
done